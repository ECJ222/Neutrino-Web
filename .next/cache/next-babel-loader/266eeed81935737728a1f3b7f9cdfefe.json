{"ast":null,"code":"import _Object$defineProperty from \"@babel/runtime-corejs2/core-js/object/define-property\";\nimport _Object$defineProperties from \"@babel/runtime-corejs2/core-js/object/define-properties\";\nimport _Object$getOwnPropertyDescriptors from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptors\";\nimport _Object$getOwnPropertyDescriptor from \"@babel/runtime-corejs2/core-js/object/get-own-property-descriptor\";\nimport _Object$getOwnPropertySymbols from \"@babel/runtime-corejs2/core-js/object/get-own-property-symbols\";\nimport _Object$keys from \"@babel/runtime-corejs2/core-js/object/keys\";\nimport _Promise from \"@babel/runtime-corejs2/core-js/promise\";\nimport _extends from \"@babel/runtime-corejs2/helpers/esm/extends\";\nimport _defineProperty from \"@babel/runtime-corejs2/helpers/esm/defineProperty\";\nvar _jsxFileName = \"/usr/local/var/www/neutrino-web/node_modules/yii-steroids/components/HttpComponent.js\";\nvar __jsx = React.createElement;\n\nfunction ownKeys(object, enumerableOnly) { var keys = _Object$keys(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nimport React from 'react';\nimport _trimStart from 'lodash-es/trimStart';\nimport _trimEnd from 'lodash-es/trimEnd';\nimport { setFlashes } from '../actions/notifications';\nimport axios from 'axios';\nimport _isFunction from 'lodash-es/isFunction';\nimport _isObject from 'lodash-es/isObject';\nexport default class HttpComponent {\n  constructor() {\n    this.apiUrl = location.protocol + '//' + location.host;\n    this.accessTokenKey = 'accessToken';\n    this._lazyRequests = {};\n    this._axios = null;\n    this._csrfToken = null;\n    this._accessToken = false;\n  }\n\n  getAxiosConfig() {\n    const config = {\n      withCredentials: true,\n      headers: {\n        // Add XMLHttpRequest header for detect ajax requests\n        'X-Requested-With': 'XMLHttpRequest',\n        // Add Content-Type\n        'Content-Type': 'application/json'\n      }\n    }; // Add CSRF header\n\n    if (!this._csrfToken && !process.env.IS_NODE) {\n      const metaElement = document.querySelector('meta[name=csrf-token]');\n\n      if (metaElement) {\n        this._csrfToken = metaElement.getAttribute('content');\n      }\n    }\n\n    if (this._csrfToken) {\n      config.headers['X-CSRF-Token'] = this._csrfToken;\n    } // Set access token\n\n\n    const clientStorage = require('components').clientStorage;\n\n    if (this._accessToken === false) {\n      this._accessToken = clientStorage.get(this.accessTokenKey) || null;\n    }\n\n    if (this._accessToken) {\n      config.headers['Authorization'] = 'Bearer ' + this._accessToken;\n    }\n\n    return config;\n  }\n  /**\n   * @param value\n   */\n\n\n  setCsrfToken(value) {\n    this._csrfToken = value;\n    this.resetConfig();\n  }\n  /**\n   * @param value\n   */\n\n\n  setAccessToken(value) {\n    this._accessToken = value;\n    this.resetConfig();\n\n    const clientStorage = require('components').clientStorage;\n\n    clientStorage.set(this.accessTokenKey, value);\n  }\n  /**\n   * @returns {string}\n   */\n\n\n  getAccessToken() {\n    if (this._accessToken === false) {\n      const clientStorage = require('components').clientStorage;\n\n      this._accessToken = clientStorage.get(this.accessTokenKey) || null;\n    }\n\n    return this._accessToken;\n  }\n\n  resetConfig() {\n    this._axios = null;\n  }\n\n  getAxiosInstance() {\n    if (!this._axios) {\n      this._axios = axios.create(this.getAxiosConfig());\n    }\n\n    return this._axios;\n  }\n\n  getUrl(method) {\n    if (method === null) {\n      method = location.pathname;\n    }\n\n    if (method.indexOf('://') === -1) {\n      method = `${_trimEnd(this.apiUrl, '/')}/${_trimStart(method, '/')}`;\n    }\n\n    return method;\n  }\n\n  get(url, params = {}, options = {}) {\n    return this._send(url, {\n      method: 'get',\n      params: params\n    }, options).then(response => response.data);\n  }\n\n  post(url, params = {}, options = {}) {\n    return this._send(url, {\n      method: 'post',\n      data: params\n    }, options).then(response => response.data);\n  }\n\n  delete(url, params = {}, options = {}) {\n    return this._send(url, {\n      method: 'delete',\n      data: params\n    }, options).then(response => response.data);\n  }\n\n  send(method, url, params = {}, options = {}) {\n    method = method.toLowerCase();\n    return this._send(url, {\n      method,\n      [method === 'get' ? 'params' : 'data']: params\n    }, options, true);\n  }\n\n  hoc(requestFunc) {\n    return WrappedComponent => {\n      var _class, _temp;\n\n      return _temp = _class = class HttpHOC extends React.Component {\n        constructor() {\n          super(...arguments);\n          this.state = {\n            data: null\n          };\n          this._isRendered = false;\n          this._cancels = [];\n          this._fetch = this._fetch.bind(this);\n          this._createCancelToken = this._createCancelToken.bind(this);\n        }\n\n        componentDidMount() {\n          this._isRendered = true;\n\n          this._fetch();\n        }\n\n        componentWillUnmount() {\n          this._isRendered = false;\n\n          this._cancels.forEach(cancel => cancel('Canceled on unmount component'));\n        }\n\n        render() {\n          return __jsx(WrappedComponent, _extends({}, this.props, this.state.data, {\n            fetch: this._fetch,\n            __source: {\n              fileName: _jsxFileName,\n              lineNumber: 170\n            },\n            __self: this\n          }));\n        }\n\n        _createCancelToken() {\n          return new axios.CancelToken(cancel => {\n            this._cancels.push(cancel);\n          });\n        }\n\n        _fetch(params) {\n          const result = requestFunc(_objectSpread({}, this.props, {}, params, {\n            createCancelToken: this._createCancelToken\n          }));\n\n          if (_isObject(result)) {\n            if (_isFunction(result.then)) {\n              return result.then(data => {\n                if (this._isRendered) {\n                  this.setState({\n                    data\n                  });\n                }\n\n                return data;\n              });\n            } else {\n              this.setState({\n                data: result\n              });\n            }\n          }\n\n          return result;\n        }\n\n      }, _defineProperty(_class, \"WrappedComponent\", WrappedComponent), _temp;\n    };\n  }\n\n  _send(method, config, options) {\n    const axiosConfig = _objectSpread({}, config, {\n      url: this.getUrl(method)\n    });\n\n    if (options.cancelToken) {\n      axiosConfig.cancelToken = options.cancelToken;\n    }\n\n    if (options.lazy) {\n      if (this._lazyRequests[method]) {\n        clearTimeout(this._lazyRequests[method]);\n      }\n\n      return new _Promise((resolve, reject) => {\n        const timeout = options.lazy !== true ? options.lazy : 200;\n        this._lazyRequests[method] = setTimeout(() => {\n          this._sendAxios(axiosConfig).then(result => resolve(result)).catch(result => reject(result));\n        }, timeout);\n      });\n    }\n\n    return this._sendAxios(axiosConfig);\n  }\n\n  _sendAxios(config) {\n    return this.getAxiosInstance()(config).then(response => {\n      this.afterRequest(response);\n      return response;\n    });\n  }\n\n  afterRequest(response) {\n    const store = require('components').store; // Flash\n\n\n    if (response.data.flashes) {\n      store.dispatch(setFlashes(response.data.flashes));\n    } // Ajax redirect\n\n\n    if (response.data.redirectUrl) {\n      if (location.href === response.data.redirectUrl.split('#')[0]) {\n        window.location.href = response.data.redirectUrl;\n        window.location.reload();\n      } else {\n        window.location.href = response.data.redirectUrl;\n      }\n    }\n  }\n\n}","map":{"version":3,"sources":["/usr/local/var/www/neutrino-web/node_modules/yii-steroids/components/HttpComponent.js"],"names":["React","_trimStart","_trimEnd","setFlashes","axios","_isFunction","_isObject","HttpComponent","constructor","apiUrl","location","protocol","host","accessTokenKey","_lazyRequests","_axios","_csrfToken","_accessToken","getAxiosConfig","config","withCredentials","headers","process","env","IS_NODE","metaElement","document","querySelector","getAttribute","clientStorage","require","get","setCsrfToken","value","resetConfig","setAccessToken","set","getAccessToken","getAxiosInstance","create","getUrl","method","pathname","indexOf","url","params","options","_send","then","response","data","post","delete","send","toLowerCase","hoc","requestFunc","WrappedComponent","HttpHOC","Component","arguments","state","_isRendered","_cancels","_fetch","bind","_createCancelToken","componentDidMount","componentWillUnmount","forEach","cancel","render","props","CancelToken","push","result","createCancelToken","setState","axiosConfig","cancelToken","lazy","clearTimeout","resolve","reject","timeout","setTimeout","_sendAxios","catch","afterRequest","store","flashes","dispatch","redirectUrl","href","split","window","reload"],"mappings":"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","sourcesContent":["import React from 'react';\nimport _trimStart from 'lodash-es/trimStart';\nimport _trimEnd from 'lodash-es/trimEnd';\nimport {setFlashes} from '../actions/notifications';\nimport axios from 'axios';\nimport _isFunction from 'lodash-es/isFunction';\nimport _isObject from 'lodash-es/isObject';\n\nexport default class HttpComponent {\n\n    constructor() {\n        this.apiUrl = location.protocol + '//' + location.host;\n        this.accessTokenKey = 'accessToken';\n\n        this._lazyRequests = {};\n        this._axios = null;\n        this._csrfToken = null;\n        this._accessToken = false;\n    }\n\n    getAxiosConfig() {\n        const config = {\n            withCredentials: true,\n            headers: {\n                // Add XMLHttpRequest header for detect ajax requests\n                'X-Requested-With': 'XMLHttpRequest',\n\n                // Add Content-Type\n                'Content-Type': 'application/json',\n            }\n        };\n\n        // Add CSRF header\n        if (!this._csrfToken && !process.env.IS_NODE) {\n            const metaElement = document.querySelector('meta[name=csrf-token]');\n            if (metaElement) {\n                this._csrfToken = metaElement.getAttribute('content');\n            }\n        }\n        if (this._csrfToken) {\n            config.headers['X-CSRF-Token'] = this._csrfToken;\n        }\n\n        // Set access token\n        const clientStorage = require('components').clientStorage;\n        if (this._accessToken === false) {\n            this._accessToken = clientStorage.get(this.accessTokenKey) || null;\n        }\n        if (this._accessToken) {\n            config.headers['Authorization'] = 'Bearer ' + this._accessToken;\n        }\n\n        return config;\n    }\n\n    /**\n     * @param value\n     */\n    setCsrfToken(value) {\n        this._csrfToken = value;\n        this.resetConfig();\n    }\n\n    /**\n     * @param value\n     */\n    setAccessToken(value) {\n        this._accessToken = value;\n        this.resetConfig();\n\n        const clientStorage = require('components').clientStorage;\n        clientStorage.set(this.accessTokenKey, value);\n    }\n\n    /**\n     * @returns {string}\n     */\n    getAccessToken() {\n        if (this._accessToken === false) {\n            const clientStorage = require('components').clientStorage;\n            this._accessToken = clientStorage.get(this.accessTokenKey) || null;\n        }\n        return this._accessToken;\n    }\n\n    resetConfig() {\n        this._axios = null;\n    }\n\n    getAxiosInstance() {\n        if (!this._axios) {\n            this._axios = axios.create(this.getAxiosConfig());\n        }\n        return this._axios;\n    }\n\n    getUrl(method) {\n        if (method === null) {\n            method = location.pathname;\n        }\n        if (method.indexOf('://') === -1) {\n            method = `${_trimEnd(this.apiUrl, '/')}/${_trimStart(method, '/')}`;\n        }\n        return method;\n    }\n\n    get(url, params = {}, options = {}) {\n        return this._send(url, {\n            method: 'get',\n            params: params,\n        }, options)\n            .then(response => response.data);\n    }\n\n    post(url, params = {}, options = {}) {\n        return this._send(url, {\n            method: 'post',\n            data: params,\n        }, options)\n            .then(response => response.data);\n    }\n\n    delete(url, params = {}, options = {}) {\n        return this._send(url, {\n            method: 'delete',\n            data: params,\n        }, options)\n            .then(response => response.data);\n    }\n\n    send(method, url, params = {}, options = {}) {\n        method = method.toLowerCase();\n\n        return this._send(url, {\n            method,\n            [method === 'get' ? 'params' : 'data']: params,\n        }, options, true);\n    }\n\n    hoc(requestFunc) {\n        return WrappedComponent => class HttpHOC extends React.Component {\n\n            static WrappedComponent = WrappedComponent;\n\n            constructor() {\n                super(...arguments);\n\n                this.state = {\n                    data: null,\n                };\n\n                this._isRendered = false;\n                this._cancels = [];\n                this._fetch = this._fetch.bind(this);\n                this._createCancelToken = this._createCancelToken.bind(this);\n            }\n\n            componentDidMount() {\n                this._isRendered = true;\n                this._fetch();\n            }\n\n            componentWillUnmount() {\n                this._isRendered = false;\n                this._cancels.forEach(cancel => cancel('Canceled on unmount component'));\n            }\n\n            render() {\n                return (\n                    <WrappedComponent\n                        {...this.props}\n                        {...this.state.data}\n                        fetch={this._fetch}\n                    />\n                );\n            }\n\n            _createCancelToken() {\n                return new axios.CancelToken(cancel => {\n                    this._cancels.push(cancel);\n                });\n            }\n\n            _fetch(params) {\n                const result = requestFunc({\n                    ...this.props,\n                    ...params,\n                    createCancelToken: this._createCancelToken,\n                });\n\n                if (_isObject(result)) {\n                    if (_isFunction(result.then)) {\n                        return result.then(data => {\n                            if (this._isRendered) {\n                                this.setState({data});\n                            }\n                            return data;\n                        });\n                    } else {\n                        this.setState({data: result});\n                    }\n                }\n\n                return result;\n            }\n\n        };\n    }\n\n    _send(method, config, options) {\n        const axiosConfig = {\n            ...config,\n            url: this.getUrl(method),\n        };\n\n        if (options.cancelToken) {\n            axiosConfig.cancelToken = options.cancelToken;\n        }\n\n        if (options.lazy) {\n            if (this._lazyRequests[method]) {\n                clearTimeout(this._lazyRequests[method]);\n            }\n\n            return new Promise((resolve, reject) => {\n                const timeout = options.lazy !== true ? options.lazy : 200;\n                this._lazyRequests[method] = setTimeout(() => {\n                    this._sendAxios(axiosConfig)\n                        .then(result => resolve(result))\n                        .catch(result => reject(result));\n                }, timeout);\n            });\n        }\n\n        return this._sendAxios(axiosConfig);\n    }\n\n    _sendAxios(config) {\n        return this.getAxiosInstance()(config)\n            .then(response => {\n                this.afterRequest(response);\n                return response;\n            });\n    }\n\n    afterRequest(response) {\n        const store = require('components').store;\n\n        // Flash\n        if (response.data.flashes) {\n            store.dispatch(setFlashes(response.data.flashes));\n        }\n\n        // Ajax redirect\n        if (response.data.redirectUrl) {\n            if (location.href === response.data.redirectUrl.split('#')[0]) {\n                window.location.href = response.data.redirectUrl;\n                window.location.reload();\n            } else {\n                window.location.href = response.data.redirectUrl;\n            }\n        }\n    }\n\n}\n"]},"metadata":{},"sourceType":"module"}